<!DOCTYPE html>
<html>
<body>

<a href="/dashboard.html">← Dashboard</a>
<hr>

<p id="loading">Loading...</p>

<h2>Available Tutors</h2>

<ul id="tutorList"></ul>

<script type="module">
  import { supabase } from "./supabase.js";
  import { requireRole } from "./guard.js";

  async function loadTutors() {
    const { data: tutors, error } = await supabase
      .from("profiles")
      .select("id, mode, availability")
      .eq("role", "tutor");

    if (error) {
      document.getElementById("loading").innerText =
        "Failed to load tutors.";
      return;
    }

    if (!tutors || tutors.length === 0) {
      document.getElementById("tutorList").innerText =
        "No tutors available yet.";
      return;
    }

    const list = document.getElementById("tutorList");

    for (const tutor of tutors) {
      const anonName = "Tutor-" + tutor.id.slice(-4);

      const { data: reviews } = await supabase
        .from("reviews")
        .select("comment")
        .eq("tutor_id", tutor.id);

      const reviewText = reviews && reviews.length
        ? reviews.map(r => `• ${r.comment}`).join("<br>")
        : "No reviews yet";

      const li = document.createElement("li");
      li.innerHTML = `
        <strong>${anonName}</strong><br>
        Mode: ${tutor.mode || "Not set"}<br>
        Availability: ${tutor.availability || "Not set"}<br>
        <em>Reviews:</em><br>
        ${reviewText}
        <hr>
      `;

      list.appendChild(li);
    }
  }

  async function init() {
    const access = await requireRole(["student"]);
    if (!access.ok) {
      document.getElementById("loading").innerText = "Access denied";
      return;
    }

    document.getElementById("loading").style.display = "none";
    await loadTutors();
  }

  init();
</script>

</body>
</html>
