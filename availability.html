<script type="module">
import { supabase } from "./supabase.js";
import { requireAuth } from "./guard.js";

async function init() {
  const access = await requireAuth(["tutor"]);
  if (!access.ok) {
    document.body.innerHTML = "Access denied";
    return;
  }
  await loadSlots();
}

async function loadSlots() {
  const { data: { user } } = await supabase.auth.getUser();

  const { data: slots, error } = await supabase
    .from("availability_slots")
    .select("*")
    .eq("tutor_id", user.id)
    .order("start_time");

  const container = document.getElementById("slots");
  container.innerHTML = "";

  if (!slots || slots.length === 0) {
    container.innerHTML = "<p class='muted'>No slots yet.</p>";
    return;
  }

  slots.forEach(slot => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <strong>${new Date(slot.start_time).toLocaleString()}</strong> â†’
      ${new Date(slot.end_time).toLocaleString()}
      <br>
      <button onclick="removeSlot('${slot.id}')">Delete</button>
    `;
    container.appendChild(div);
  });
}

window.addSlot = async function () {
  const startLocal = document.getElementById("start").value;
  const endLocal = document.getElementById("end").value;
  const result = document.getElementById("result");

  const startUtc = new Date(startLocal).toISOString();
  const endUtc = new Date(endLocal).toISOString();

  const { data: { user } } = await supabase.auth.getUser();

  const { error } = await supabase.from("availability_slots").insert({
    tutor_id: user.id,
    start_time: startUtc,
    end_time: endUtc,
    status: "available"
  });

  if (error) {
    if (error.message.includes("no_overlapping_slots")) {
      result.innerText = "Time overlaps with existing slot.";
    } else {
      result.innerText = error.message;
    }
    return;
  }

  result.innerText = "Slot added.";
  loadSlots();
};

window.removeSlot = async function (id) {
  await supabase.from("availability_slots").delete().eq("id", id);
  loadSlots();
};

init();
</script>
