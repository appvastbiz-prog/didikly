<!DOCTYPE html>
<html>
<body>

<a href="/dashboard.html">‚Üê Dashboard</a>
<hr>

<p id="loading">Loading...</p>

<h2>Session</h2>
<p id="info"></p>

<script type="module">
  import { supabase } from "./supabase.js";
  import { requireRole } from "./guard.js";

  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  async function init() {
    const access = await requireRole(["student", "tutor"]);
    if (!access.ok) {
      document.getElementById("loading").innerText = "Access denied";
      return;
    }

    document.getElementById("loading").style.display = "none";
    await load(access.role);
  }

  async function load(role) {
    const { data: session, error } = await supabase
      .from("sessions")
      .select("*")
      .eq("id", id)
      .single();

    if (error) {
      document.getElementById("info").innerText = error.message;
      return;
    }

    let actions = "";

    if (role === "tutor" && session.status === "accepted") {
      actions = `<button id="complete">Mark completed</button>`;
    }

    if (role === "student" && session.status === "completed") {
      actions = `<a href="/review.html?session=${id}">Leave review</a>`;
    }

    document.getElementById("info").innerHTML = `
      Session ID: ${id}<br>
      Mode: ${session.mode}<br>
      Status: ${session.status}<br><br>
      ${actions}
    `;

    if (role === "tutor" && session.status === "accepted") {
      document.getElementById("complete").onclick = async () => {
        await supabase
          .from("sessions")
          .update({ status: "completed" })
          .eq("id", id);
        location.reload();
      };
    }
  }

  init();
</script>

</body>
</html>
