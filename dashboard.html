<!DOCTYPE html>
<html>
<body>

<p id="loading">Loading...</p>

<h2>
  <a href="/dashboard.html" style="text-decoration:none; color:inherit;">
    Dashboard
  </a>
</h2>
<hr>


<p id="user"></p>

<div id="student" style="display:none;">
  <h3>Student</h3>
  <ul>
    <li><a href="/mode.html">Select learning mode</a></li>
    <li><a href="/tutors.html">View tutors</a></li>
    <li><a href="/request.html">Request session</a></li>
    <li><a href="/sessions.html">My sessions</a></li>
  </ul>
</div>

<div id="tutor" style="display:none;">
  <h3>Tutor</h3>
  <ul>
    <li><a href="/availability.html">Set availability</a></li>
    <li><a href="/requests.html">View session requests</a></li>
    <li><a href="/sessions.html">My sessions</a></li>
  </ul>
</div>

<button onclick="logout()">Logout</button>


<script type="module">
  import { supabase } from "./supabase.js";

  async function loadUser() {
    const {
      data: { user },
    } = await supabase.auth.getUser();

    if (!user) {
      window.location.href = "/login.html";
      return;
    }

    // Hide loading once auth check passes
    document.getElementById("loading").style.display = "none";

    let { data: profile, error } = await supabase
      .from("profiles")
      .select("role")
      .eq("id", user.id)
      .single();
    
    if (error && error.code !== "PGRST116") {
      document.getElementById("user").innerText =
        "Failed to load profile.";
      return;
    }
    
    // ðŸ‘‡ AUTO-CREATE PROFILE IF MISSING
    if (!profile) {
      await supabase.from("profiles").insert({
        id: user.id,
        role: "student",
      });
    
      profile = { role: "student" };
    }


    document.getElementById("user").innerText =
      "Logged in as: " + user.email + " (" + profile.role + ")";

    if (profile.role === "student") {
      document.getElementById("student").style.display = "block";
    }

    if (profile.role === "tutor") {
      document.getElementById("tutor").style.display = "block";
    }
  }

  window.logout = async function () {
    await supabase.auth.signOut();
    window.location.href = "/login.html";
  };

  loadUser();
</script>





</body>
</html>
