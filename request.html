<!DOCTYPE html>
<html>
<head>
  <title>Request Session – Didikly</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; }
    .container { max-width:720px; margin:0 auto; padding:24px; }
    .topbar { display:flex; justify-content:space-between; margin-bottom:16px; }
    .card { background:#020617; padding:24px; border-radius:12px; margin-bottom:12px; }
    button { background:#38bdf8; color:#020617; font-weight:600; cursor:pointer; border:none; padding:10px 14px; border-radius:8px; }
    a { color:#38bdf8; text-decoration:none; }
    .muted { color:#94a3b8; }
  </style>
</head>
<body>

<div class="container">

  <div class="topbar">
    <a href="/dashboard.html">← Dashboard</a>
    <a href="/dashboard.html">Home</a>
  </div>

  <h2>Request Session</h2>
  <p class="muted">Click a slot to book it (locks for 10 minutes)</p>

  <div id="slots"></div>
  <p id="result" class="muted"></p>

</div>

<script type="module">
import { supabase } from "./supabase.js";
import { requireAuth } from "./guard.js";

const params = new URLSearchParams(window.location.search);
const tutorId = params.get("tutor");

async function init() {
  const access = await requireAuth(["student"]);
  if (!access.ok) {
    document.body.innerHTML = "Access denied";
    return;
  }

  if (!tutorId) {
    document.getElementById("slots").innerHTML =
      "<p class='muted'>Missing tutor. Go back and select a tutor.</p>";
    return;
  }

  loadSlots();
}

async function loadSlots() {
  const now = new Date().toISOString();

  const { data: slots, error } = await supabase
    .from("availability_slots")
    .select("*")
    .eq("tutor_id", tutorId)
    .eq("status", "available")
    .or(`locked_until.is.null,locked_until.lt.${now}`)
    .order("start_time");

  const container = document.getElementById("slots");
  container.innerHTML = "";

  if (error) {
    container.innerHTML = "<p class='muted'>Failed to load slots.</p>";
    console.error(error);
    return;
  }

  if (!slots || slots.length === 0) {
    container.innerHTML = "<p class='muted'>No slots available.</p>";
    return;
  }

  slots.forEach(slot => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>${new Date(slot.start_time).toLocaleString()}</b> →
      ${new Date(slot.end_time).toLocaleString()}
      <br><br>
      <button onclick="bookSlot('${slot.id}')">Book this slot</button>
    `;
    container.appendChild(div);
  });
}

window.bookSlot = async function (slotId) {
  const result = document.getElementById("result");

  const { data: { user } } = await supabase.auth.getUser();

  const { data: session, error: sessionErr } = await supabase
    .from("sessions")
    .insert({
      student_id: user.id,
      tutor_id: tutorId,
      status: "requested"
    })
    .select()
    .single();

  if (sessionErr) {
    result.innerText = sessionErr.message;
    return;
  }

  const { data, error } = await supabase.rpc("book_slot", {
    slot_uuid: slotId,
    session_uuid: session.id
  });

  if (!data) {
    result.innerText = "Slot was already taken.";
    return;
  }

  result.innerText = "Slot locked for 10 minutes.";
  loadSlots();
};

init();
</script>

</body>
</html>
